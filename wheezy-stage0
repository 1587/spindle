#!/bin/sh
# Part of spindle http://asbradbury.org/projects/spindle
#
# See LICENSE file for copyright and license details

set -e

CURIMG=stage0.qed

. ./common

create_partition_table() {
  # TODO: partition sizes shouldn't be hard-coded and I should have a swap 
  # partition
  sudo parted $1 <<EOF
  unit mb
  mklabel msdos
  mkpart primary fat32 0 100
  mkpart primary ext4 104 1800
  mkpart primary linux-swap 1800 1900
  print
  quit
EOF
}

do_debootstrap() {
  # Need bzip2 for http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=657560
  sudo debootstrap --components=main,contrib,non-free \
  --verbose \
  --foreign --arch armel --include=bzip2 \
  $1 $2 $DEB_MIRROR
}

OLDDIR=$(pwd)
mkdir -p $WORKDIR
cd $WORKDIR
[ -b "$NBD_DEV" ] || die "nbd device '%s' does not exist. Try sudo modprobe nbd max_part=16" "$NBD_DEV"
dotask qemu-img create -f qed $CURIMG 1900M
sudo -v
dotask attach_image_to_nbd $CURIMG $NBD_DEV
dotask create_partition_table $NBD_DEV
dotask sudo mkdosfs $BOOT_DEV
dotask sudo mkfs.ext4 -O ^huge_file $ROOT_DEV
dotask sudo mkswap $SWAP_DEV
mkdir -p boot
dotask sudo mount $BOOT_DEV boot
mkdir -p rootfs
dotask sudo mount $ROOT_DEV rootfs
dotask do_debootstrap wheezy rootfs
universal_cleanup
chmod -w $CURIMG
cd "$OLDDIR"
mkdir -p $OUTDIR
mv $WORKDIR/$CURIMG $OUTDIR
FINISHED_SUCCESSFULLY=1
